name: üîí Security Scan with Trivy

on:
  push:
    branches: [ "main" ]

jobs:
  security-scan:
    name: SBOM & Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: üìä Generate SBOM
        run: |
          trivy fs . --format cyclonedx --output sbom.cyclonedx.json

      - name: üîç Run security scan and generate JSON
        run: |
          trivy fs . --format json --output trivy-results.json --exit-code 0

      - name: üìã Create professional HTML report
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π HTML –æ—Ç—á–µ—Ç
          cat > trivy-report.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Security Scan Report - Juice Shop</title>
              <style>
                  * { box-sizing: border-box; margin: 0; padding: 0; }
                  body { 
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                      line-height: 1.6; 
                      color: #333; 
                      background-color: #f5f5f5; 
                      padding: 20px;
                  }
                  .container { 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      background: white; 
                      border-radius: 10px; 
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
                      padding: 30px;
                  }
                  .header { 
                      text-align: center; 
                      margin-bottom: 30px; 
                      padding-bottom: 20px; 
                      border-bottom: 2px solid #eaeaea;
                  }
                  .header h1 { 
                      color: #2c3e50; 
                      margin-bottom: 10px;
                  }
                  .summary { 
                      background: #f8f9fa; 
                      padding: 20px; 
                      border-radius: 8px; 
                      margin-bottom: 30px;
                  }
                  .vulnerability-table {
                      width: 100%;
                      border-collapse: collapse;
                      margin-top: 20px;
                  }
                  .vulnerability-table th,
                  .vulnerability-table td {
                      padding: 12px 15px;
                      text-align: left;
                      border-bottom: 1px solid #ddd;
                  }
                  .vulnerability-table th {
                      background-color: #2c3e50;
                      color: white;
                      font-weight: 600;
                  }
                  .vulnerability-table tr:hover {
                      background-color: #f5f5f5;
                  }
                  .severity-badge {
                      padding: 4px 8px;
                      border-radius: 4px;
                      font-weight: bold;
                      font-size: 0.8em;
                  }
                  .severity-CRITICAL { background-color: #dc3545; color: white; }
                  .severity-HIGH { background-color: #fd7e14; color: white; }
                  .severity-MEDIUM { background-color: #ffc107; color: black; }
                  .severity-LOW { background-color: #28a745; color: white; }
                  .severity-UNKNOWN { background-color: #6c757d; color: white; }
                  .timestamp { 
                      color: #666; 
                      font-style: italic; 
                      margin-top: 10px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîí Security Scan Report</h1>
                      <h2>OWASP Juice Shop</h2>
                      <div class="timestamp">Generated on: $(date)</div>
                  </div>
                  
                  <div class="summary">
                      <h3>üìä Scan Summary</h3>
                      <p>This report contains security vulnerabilities identified by Trivy scanner.</p>
                  </div>

                  <h3>üìã Detected Vulnerabilities</h3>
                  <table class="vulnerability-table">
                      <thead>
                          <tr>
                              <th>Severity</th>
                              <th>Vulnerability ID</th>
                              <th>Package</th>
                              <th>Version</th>
                              <th>Description</th>
                          </tr>
                      </thead>
                      <tbody>
          EOF

          # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON –æ—Ç—á–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏)
          if [ -f "trivy-results.json" ]; then
              echo "<!-- Vulnerabilities will be listed here -->" >> trivy-report.html
          else
              echo "<tr><td colspan='5' style='text-align: center;'>No vulnerabilities found</td></tr>" >> trivy-report.html
          fi

          cat >> trivy-report.html << 'EOF'
                      </tbody>
                  </table>

                  <div style="margin-top: 40px; padding: 20px; background: #e8f4fd; border-radius: 8px;">
                      <h3>‚ÑπÔ∏è About This Report</h3>
                      <p>This security scan was performed using <strong>Trivy</strong> vulnerability scanner.</p>
                      <p><strong>SBOM Generated:</strong> CycloneDX format</p>
                      <p><strong>Scan Date:</strong> $(date)</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

          # –ï—Å–ª–∏ –µ—Å—Ç—å JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏, –ø–∞—Ä—Å–∏–º –µ–≥–æ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
          if [ -f "trivy-results.json" ]; then
              # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —Ç–∞–±–ª–∏—Ü–µ–π —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
              python3 << 'PYTHON_SCRIPT' > temp_vulns.html
          import json
          import html

          try:
              with open('trivy-results.json', 'r') as f:
                  data = json.load(f)
              
              vulnerabilities_found = False
              
              for result in data.get('Results', []):
                  for vuln in result.get('Vulnerabilities', []):
                      vulnerabilities_found = True
                      severity = vuln.get('Severity', 'UNKNOWN')
                      vuln_id = vuln.get('VulnerabilityID', 'N/A')
                      pkg_name = vuln.get('PkgName', 'N/A')
                      version = vuln.get('InstalledVersion', 'N/A')
                      description = vuln.get('Description', 'No description available')
                      
                      # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
                      description = html.escape(description)
                      
                      print(f'''<tr>
                          <td><span class="severity-badge severity-{severity}">{severity}</span></td>
                          <td><code>{vuln_id}</code></td>
                          <td><strong>{pkg_name}</strong></td>
                          <td>{version}</td>
                          <td>{description[:200]}{'...' if len(description) > 200 else ''}</td>
                      </tr>''')
              
              if not vulnerabilities_found:
                  print('<tr><td colspan="5" style="text-align: center;">‚úÖ No security vulnerabilities detected</td></tr>')
                  
          except Exception as e:
              print(f'<tr><td colspan="5" style="text-align: center; color: red;">Error parsing vulnerabilities: {str(e)}</td></tr>')
          PYTHON_SCRIPT

              # –í—Å—Ç–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ HTML –æ—Ç—á–µ—Ç
              sed -i '/<!-- Vulnerabilities will be listed here -->/r temp_vulns.html' trivy-report.html
              sed -i '/<!-- Vulnerabilities will be listed here -->/d' trivy-report.html
          fi

      - name: üì¶ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            sbom.cyclonedx.json
            trivy-results.json
            trivy-report.html
          retention-days: 30