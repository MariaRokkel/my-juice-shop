name: üîí Security Scan with Trivy

on:
  push:
    branches: [ "main" ]

jobs:
  security-scan:
    name: SBOM & Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Install dependencies
        run: |
          npm install

      - name: üîß Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: üìä Generate SBOM
        run: |
          trivy fs . --format cyclonedx --output sbom.cyclonedx.json

      - name: üîç Run vulnerability scan
        run: |
          trivy fs . \
            --scanners vuln \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output trivy-results.json \
            --exit-code 0

      - name: üìã Create professional HTML report
        run: |
          python3 << 'EOF' > trivy-report.html
          import json
          import html
          from datetime import datetime

          # –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          try:
              with open('trivy-results.json', 'r') as f:
                  data = json.load(f)
          except:
              data = {}

          # –°–æ–∑–¥–∞–µ–º HTML –æ—Ç—á–µ—Ç
          html_content = f'''
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Security Scan Report - Juice Shop</title>
              <style>
                  * {{
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }}
                  body {{
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }}
                  .container {{
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 15px;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                      overflow: hidden;
                  }}
                  .header {{
                      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
                      color: white;
                      padding: 40px 30px;
                      text-align: center;
                  }}
                  .header h1 {{
                      font-size: 2.5em;
                      margin-bottom: 10px;
                      font-weight: 300;
                  }}
                  .header h2 {{
                      font-size: 1.2em;
                      font-weight: 300;
                      opacity: 0.9;
                  }}
                  .summary {{
                      background: #f8f9fa;
                      padding: 30px;
                      border-bottom: 1px solid #eaeaea;
                  }}
                  .stats {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }}
                  .stat-card {{
                      background: white;
                      padding: 20px;
                      border-radius: 10px;
                      text-align: center;
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                  }}
                  .stat-number {{
                      font-size: 2em;
                      font-weight: bold;
                      margin-bottom: 5px;
                  }}
                  .critical {{ color: #dc3545; }}
                  .high {{ color: #fd7e14; }}
                  .medium {{ color: #ffc107; }}
                  .low {{ color: #28a745; }}
                  .vulnerabilities {{
                      padding: 30px;
                  }}
                  .vulnerability-table {{
                      width: 100%;
                      border-collapse: collapse;
                      margin-top: 20px;
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                      border-radius: 10px;
                      overflow: hidden;
                  }}
                  .vulnerability-table th {{
                      background: #2c3e50;
                      color: white;
                      padding: 15px;
                      text-align: left;
                      font-weight: 600;
                      text-transform: uppercase;
                      font-size: 0.9em;
                      letter-spacing: 0.5px;
                  }}
                  .vulnerability-table td {{
                      padding: 15px;
                      border-bottom: 1px solid #eaeaea;
                      vertical-align: top;
                  }}
                  .vulnerability-table tr:hover {{
                      background-color: #f8f9fa;
                  }}
                  .severity-badge {{
                      padding: 6px 12px;
                      border-radius: 20px;
                      font-weight: bold;
                      font-size: 0.8em;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                  }}
                  .severity-CRITICAL {{ background-color: #dc3545; color: white; }}
                  .severity-HIGH {{ background-color: #fd7e14; color: white; }}
                  .severity-MEDIUM {{ background-color: #ffc107; color: black; }}
                  .severity-LOW {{ background-color: #28a745; color: white; }}
                  .footer {{
                      background: #34495e;
                      color: white;
                      padding: 20px;
                      text-align: center;
                      font-size: 0.9em;
                  }}
                  .no-vulns {{
                      text-align: center;
                      padding: 40px;
                      color: #666;
                      font-size: 1.1em;
                  }}
                  .package-name {{
                      font-weight: bold;
                      color: #2c3e50;
                  }}
                  .vuln-id {{
                      font-family: 'Courier New', monospace;
                      background: #f8f9fa;
                      padding: 2px 6px;
                      border-radius: 4px;
                      font-size: 0.9em;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîí Security Scan Report</h1>
                      <h2>OWASP Juice Shop Vulnerability Assessment</h2>
                  </div>
                  
                  <div class="summary">
                      <h3>Executive Summary</h3>
                      <p>This report details security vulnerabilities identified in the OWASP Juice Shop application using Trivy vulnerability scanner.</p>
                      
                      <div class="stats">
          '''

          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
          vuln_count = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
          total_vulns = 0

          if data.get('Results'):
              for result in data['Results']:
                  if result.get('Vulnerabilities'):
                      for vuln in result['Vulnerabilities']:
                          severity = vuln.get('Severity', 'UNKNOWN')
                          if severity in vuln_count:
                              vuln_count[severity] += 1
                              total_vulns += 1

          html_content += f'''
                          <div class="stat-card">
                              <div class="stat-number">{total_vulns}</div>
                              <div>Total Vulnerabilities</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-number critical">{vuln_count["CRITICAL"]}</div>
                              <div>Critical</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-number high">{vuln_count["HIGH"]}</div>
                              <div>High</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-number medium">{vuln_count["MEDIUM"]}</div>
                              <div>Medium</div>
                          </div>
                      </div>
                  </div>

                  <div class="vulnerabilities">
                      <h3>üìã Detailed Vulnerability Report</h3>
          '''

          if total_vulns > 0:
              html_content += '''
                      <table class="vulnerability-table">
                          <thead>
                              <tr>
                                  <th>Severity</th>
                                  <th>Vulnerability ID</th>
                                  <th>Package</th>
                                  <th>Version</th>
                                  <th>Description</th>
                              </tr>
                          </thead>
                          <tbody>
              '''

              # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏
              for result in data.get('Results', []):
                  for vuln in result.get('Vulnerabilities', []):
                      severity = vuln.get('Severity', 'UNKNOWN')
                      vuln_id = vuln.get('VulnerabilityID', 'N/A')
                      pkg_name = vuln.get('PkgName', 'N/A')
                      version = vuln.get('InstalledVersion', 'N/A')
                      description = vuln.get('Description', 'No description available')
                      
                      # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
                      description = html.escape(description)
                      pkg_name = html.escape(pkg_name)
                      
                      html_content += f'''
                              <tr>
                                  <td><span class="severity-badge severity-{severity}">{severity}</span></td>
                                  <td><span class="vuln-id">{vuln_id}</span></td>
                                  <td><span class="package-name">{pkg_name}</span></td>
                                  <td>{version}</td>
                                  <td>{description}</td>
                              </tr>
                      '''
              
              html_content += '''
                          </tbody>
                      </table>
              '''
          else:
              html_content += '''
                      <div class="no-vulns">
                          <h3>‚úÖ No Vulnerabilities Found</h3>
                          <p>The security scan did not identify any vulnerabilities in the scanned dependencies.</p>
                      </div>
              '''

          html_content += f'''
                  </div>
                  
                  <div class="footer">
                      <p>Generated on: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
                      <p>Scanner: Trivy | Format: CycloneDX SBOM</p>
                  </div>
              </div>
          </body>
          </html>
          '''

          print(html_content)
          EOF

      - name: üìã Show scan summary
        run: |
          echo "=== SECURITY SCAN SUMMARY ==="
          trivy fs . --scanners vuln --format table --exit-code 0

      - name: üì¶ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            sbom.cyclonedx.json
            trivy-results.json
            trivy-report.html
          retention-days: 30