name: üîí Security Scan with Trivy

on:
  push:
    branches: [ "main" ]

jobs:
  security-scan:
    name: SBOM & Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: üìä Generate SBOM
        run: |
          trivy fs . --format cyclonedx --output sbom.cyclonedx.json

      - name: üîç Run security scan and generate reports
        run: |
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JSON –æ—Ç—á–µ—Ç
          trivy fs . --format json --output trivy-results.json --exit-code 0
          
          # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π HTML –æ—Ç—á–µ—Ç –≤—Ä—É—á–Ω—É—é
          echo '<!DOCTYPE html>
          <html>
          <head>
              <title>Security Scan Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .vulnerability { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
                  .critical { background-color: #ffebee; border-left: 4px solid #f44336; }
                  .high { background-color: #fff3e0; border-left: 4px solid #ff9800; }
                  .medium { background-color: #fff8e1; border-left: 4px solid #ffc107; }
                  .low { background-color: #f1f8e9; border-left: 4px solid #8bc34a; }
                  h1 { color: #333; }
                  .severity { font-weight: bold; padding: 3px 8px; border-radius: 3px; display: inline-block; }
                  .severity-CRITICAL { background-color: #f44336; color: white; }
                  .severity-HIGH { background-color: #ff9800; color: white; }
                  .severity-MEDIUM { background-color: #ffc107; color: black; }
                  .severity-LOW { background-color: #8bc34a; color: white; }
              </style>
          </head>
          <body>
          <h1>üîí Security Scan Report - Juice Shop</h1>
          <p>Generated on: '$(date)'</p>' > trivy-report.html

          # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
          echo '<h2>Scan Summary</h2>' >> trivy-report.html
          trivy fs . --format table >> trivy-report.html

          echo '</body></html>' >> trivy-report.html

      - name: üì¶ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            sbom.cyclonedx.json
            trivy-results.json
            trivy-report.html
          retention-days: 30